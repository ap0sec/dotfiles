<?php

namespace App\Http\Controllers;

use App\Picture;
use App\Question;
use Illuminate\Http\Request;

class ContentsController extends Controller
{
    public function index(Request $request){

        $picture = new Picture;
        do{
            $rand = rand(1,$picture->count());
        }while(Question::checkOverlap($request->id, $rand));

        $url = Picture::find($rand);
        $data = [
            'url' => $url["pic_id"],
            'id' => $request->id ,
            'branch' => $request->branch ,
            'time' => $request->time
        ];

        return view('contents.index', $data);
    }

    public function post(Request $request)
    {
        $picture = Picture::where('pic_id', $request->url)->first();

        if(Question::checkOverlap($request->id, $picture["id"])){
            Question::where('answer_id',$request->id)->delete();
            return view('error.overlap');
        }else{
            $data = [
                'answer_id' => $request->id ,
                'pic_id' => $picture["id"] ,
                'viewtime' => $request->viewtime ,
                'score' => $request->score
            ];

            
            
            $question = new Question;
            $question->fill($data)->save();

            

            if($request->time < 4){
                $route_param = [
                    'id' => $request->id ,
                    'branch' => $request->branch ,
                    'time' => ($request->time)+1
                ];
                return redirect()->route('contents', $route_param);
            }else{
                $route_param = [
                    'id' => $request->id
                ];
                return view('end', $route_param);
            }
        }
    }
}
